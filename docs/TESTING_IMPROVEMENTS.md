# Viteプラグインのテストケース改善提案

## 1. `packages/@smsshcss/vite/src/__tests__/setup.ts` の現状評価

Viteプラグインのテスト環境をセットアップする役割を担う現在の `setup.ts` ファイルには、いくつかの問題があります。

- **コアロジックの重複**: このファイルは、`smsshcss` コアライブラリ本来の機能であるはずのものを広範囲にわたって再実装しています。これには以下が含まれます。

  - `generateMockCSS`: `smsshcss` コアが生成すべきCSSを手動で構築しています。
  - `parseUtilityClasses`、`parseUtilityClass`、`parseUtilityWithValue`、`getThemeValue`、`parseUtilityWithDefaultValue`、`parseSimpleUtilityClass`: `smsshcss` コアのユーティリティクラスのパースとCSS生成ロジックを複製しています。
  - `mockExtractCustom...Classes` および `mockGenerateApplyClasses`: コアライブラリの抽出および生成ロジックを模倣しています。

- **`smsshcss` コアの広範なモック**: `vi.mock('smsshcss', ...)` を使用して `smsshcss` パッケージ全体がモックされており、テスト実行時に実際の `smsshcss` コアコードは使用されていません。同様に、`vi.mock('../../../../smsshcss/src/config', ...)` は、コアの設定値とゲッター関数をハードコードされた値で置き換えています。

**これらの問題の結果:**

- **高いメンテナンスコスト**: `smsshcss` コアライブラリの変更（新しいユーティリティクラス、ロジックの修正、設定の更新など）があるたびに、`setup.ts` 内のモック実装を手動で更新する必要があります。これは時間がかかり、エラーの原因となります。
- **真の統合テストの欠如**: テストは、プラグインと実際の `smsshcss` コアとの統合を検証していません。代わりに、モックされた「偽の」コアとの相互作用を検証しています。これにより、プラグインが実際の環境で正しく機能するという保証が弱まります。
- **コードの複雑性**: `setup.ts` ファイル自体が、重複したロジックのために大きく複雑になり、可読性が低下し、デバッグがより困難になっています。

## 2. 改善提案

現在のテストセットアップの根本的な問題は、Viteプラグインのテストが `smsshcss` コアライブラリの機能を再実装している点にあります。Viteプラグインのテストは、プラグインが `smsshcss` コアと**正しく統合されているか**を検証することに焦点を当てるべきです。

**提案するアプローチ:**

1.  **`smsshcss` コアのモックを最小限にする**: `smsshcss` パッケージ全体をモックするのではなく、テストに本当に必要で、テスト実行速度に大きな影響を与えたり、外部依存性を導入したりする**特定の関数のみ**をモックするようにします。
2.  **Viteプラグインの責務に焦点を当てる**: テストは、Viteプラグインが以下の点を正しく処理していることを主に確認すべきです。
    - 設定（例: `content`、`includeResetCSS`、`apply`）のパース。
    - ソースファイル（HTML、Vue、React、TSXなど）の読み込みとクラス名の抽出。
    - 抽出したクラス名とプラグイン設定を `smsshcss` コアのCSS生成関数に渡すこと。
    - Vite固有のフック（例: `transform`、`configResolved`）の処理。
    - 必要に応じたCSSのミニファイ適用。
    - ファイルシステム操作（例: 一時ディレクトリの作成/削除）。

## 3. 改善のための具体的なステップ

- **`setup.ts` から `generateMockCSS` および関連するパースロジックを削除する**: これらの関数は `smsshcss` コアライブラリの機能を重複しているため、冗長です。
- **`setup.ts` から `mockExtractCustom...Classes` および `mockGenerateApplyClasses` を削除する**: これらもコアロジックの重複です。
- **`vi.mock('smsshcss', ...)` の変更**: `smsshcss` パッケージ全体を完全に置き換えるのではなく、実際のモジュールをインポートし、**本当にモックが必要な関数のみ**を上書きするようにします。例えば、`generatePurgeReport` はテストパフォーマンスに影響を与える可能性があるため、モックされるかもしれません。

  **`vi.mock` 変更例:**

  ```typescript
  import { vi } from 'vitest';

  vi.mock('smsshcss', async (importOriginal) => {
    const actual = await importOriginal<typeof import('smsshcss')>();
    return {
      ...actual, // 実際のsmsshcssの関数を全てインポート
      // 必要に応じて、特定の関数のみをモックする
      generatePurgeReport: vi.fn().mockResolvedValue({
        totalClasses: 100,
        usedClasses: 50,
        purgedClasses: 50,
        buildTime: 100,
      }),
    };
  });
  ```

- **`vi.mock('../../../../smsshcss/src/config', ...)` の削除または簡素化**: このモックは通常、Viteプラグインのテストには不要です。Viteプラグインは `smsshcss` コアと連携すべきであり、コアは自身の設定を管理すべきです。コアの設定読み込みをモックする必要がある場合は、コアライブラリ自身のテストで行うべきです。

## 4. このアプローチの利点

- **信頼性の向上**: テストがプラグインと実際の `smsshcss` コアとの統合を検証するため、実際の環境でのパフォーマンスに対する信頼性が大幅に向上します。
- **メンテナンスコストの削減**: `smsshcss` コアの変更が `setup.ts` の更新を直接引き起こすことが少なくなり、テストコードのメンテナンスが容易になります。
- **テストコードの簡素化**: `setup.ts` が大幅に小さく、理解しやすくなり、コードの可読性とデバッグ効率が向上します。

---

## Viteプラグインのテストケースのメンテナンス性評価

Viteプラグインのテストスイート全体を分析した結果、以下の評価が得られました。

### 強み

1.  **包括的なテストカバレッジ**:
    - ユニットテスト、統合テスト、パフォーマンステスト、互換性テスト、カスタム値テスト、および様々なユーティリティクラスのテストなど、広範囲なシナリオをカバーしています。
    - `integration.test.ts` では、React、Vue、HTMLの混在プロジェクトやネストされたディレクトリ構造など、現実世界のシナリオを検証しており、プラグインの堅牢性を高めています。
2.  **明確な構造と整理**:
    - テストは、論理的なファイル（例: `compatibility.test.ts`, `custom-values.test.ts`）と `describe`/`it` ブロックに明確に整理されています。これにより、特定の機能のテストを簡単に見つけ、理解することができます。
3.  **効果的なテストヘルパーの利用**:
    - `IntegrationTestHelpers`、`TestHelpers`、`PerformanceTestHelper` といったヘルパークラスが効果的に使用されており、テストの定型コードを削減し、可読性を向上させています。これにより、新しいテストの追加や既存テストの変更が容易になっています。
4.  **データ駆動型テスト**:
    - `custom-values.test.ts` では、`testCases` オブジェクトを使用してデータ駆動型テストを効果的に実装しています。これにより、テストロジックを重複させることなく、新しいカスタム値のテストを簡単に追加できます。
5.  **テストの分離**:
    - 一時ディレクトリ (`tmpdir()`) の一貫した使用により、テストが互いに分離され、テスト実行後に副作用が残らないようになっています。
6.  **専用のパフォーマンステスト**:
    - `performance.test.ts` は、プラグインの変換時間、メモリ使用量、出力サイズを測定・検証するための専用テストファイルです。ビルドツールプラグインにとって、パフォーマンスは非常に重要であり、この専用テストは大きな強みです。

### 弱み（主に `setup.ts` に関連）

1.  **`smsshcss` コアの過剰なモック**:
    - 前回の分析で指摘したように、`setup.ts` における `smsshcss` コアの過剰なモックは、テストスイート内でコアロジックの重複を引き起こしています。これは、コアライブラリの変更があった際にテストが壊れやすく、メンテナンスが困難になる主な原因です。特に `plugin.test.ts` と `utility-classes.test.ts` は、このモックされたCSS生成に直接依存しています。
2.  **潜在的な冗長性**:
    - 一部のテスト（例: `plugin.test.ts` と `utility-classes.test.ts` における `apply` クラスのテスト）でわずかな重複が見られますが、これは軽微な問題です。

### 結論

Viteプラグインのテストスイートは、ヘルパーの利用、データ駆動型テスト、明確な構成といった点で、全体的に優れた設計とメンテナンス性を備えています。

しかし、最大のメンテナンス性のボトルネックは、`setup.ts` における `smsshcss` コアの過剰なモックです。これにより、テストスイートがコアロジックを再実装せざるを得ない状況になっています。この問題を解決し、コアモックを最小限に抑え、実際の `smsshcss` パッケージをCSS生成に利用するように変更することで、Viteプラグインのテストスイート全体のメンテナンス性は大幅に向上するでしょう。

---

## 改修計画

### 現状分析結果

コードを分析した結果、Geminiの評価は正確であることが確認されました。

**主な問題:**

- `setup.ts`が1113行の巨大ファイル
- `smsshcss`パッケージ全体が`vi.mock('smsshcss', ...)`でモック化
- コアライブラリの機能（CSS生成、パース、抽出）を重複実装
- 真の統合テストが実行されていない

**影響:**

- テストメンテナンスコストが極めて高い
- コアライブラリの変更のたびにテストコードも更新が必要
- プラグインと実際のsmsshcssコアとの統合が検証されていない

### 段階的改修計画

#### 第1段階: モック戦略の見直し（優先度: 高）

**目的:** 過剰なモックを削減し、実際の統合テストを可能にする

**作業内容:**

1. **`setup.ts`の`vi.mock('smsshcss', ...)`を変更**

   ```typescript
   // 現在の全面モック -> 部分モックに変更
   vi.mock('smsshcss', async (importOriginal) => {
     const actual = await importOriginal<typeof import('smsshcss')>();
     return {
       ...actual, // 実際のsmsshcssの関数を全てインポート
       // テストパフォーマンスに影響する特定の関数のみモック
       generatePurgeReport: vi.fn().mockResolvedValue({
         totalClasses: 100,
         usedClasses: 50,
         purgedClasses: 50,
         buildTime: 100,
       }),
     };
   });
   ```

2. **重複ロジックの削除**
   - `generateMockCSS`関数を削除
   - `parseUtilityClasses`、`parseUtilityClass`、`parseUtilityWithValue`等の削除
   - `mockExtractCustom...Classes`関数群の削除
   - `mockGenerateApplyClasses`の削除

**期待される効果:**

- `setup.ts`のサイズが大幅に縮小（1113行 → 200行以下）
- 実際のsmsshcssコアとの統合テストが可能
- メンテナンスコストの大幅削減

**リスク:**

- 既存テストが一時的に失敗する可能性
- テスト実行時間が若干増加する可能性

#### 第2段階: テストケースの修正（優先度: 中）

**目的:** 第1段階の変更に合わせてテストケースを修正

**作業内容:**

1. **`plugin.test.ts`の修正**

   - 実際のCSSGeneratorを使用するテストに変更
   - モックされたCSS出力の期待値を実際の出力に合わせて修正

2. **`utility-classes.test.ts`の修正**

   - 実際のユーティリティクラス生成結果に合わせた期待値の更新

3. **`integration.test.ts`の検証**
   - 実際の統合テストとして機能することを確認

**期待される効果:**

- テストの信頼性向上
- 実際の環境での動作保証

#### 第3段階: テスト構造の最適化（優先度: 低）

**目的:** テストコードの品質とメンテナンス性のさらなる向上

**作業内容:**

1. **テストヘルパーの整理**

   - 不要になったテストヘルパーの削除
   - 共通処理の統合

2. **テストカバレッジの検証**
   - 実際の統合テストでカバレッジが維持されることを確認
   - 不足している部分の補完

**期待される効果:**

- テストコードの可読性向上
- 長期的なメンテナンス性の向上

### 実装スケジュール

**Week 1: 第1段階**

- Day 1-2: `setup.ts`のモック戦略変更
- Day 3-4: 重複ロジックの削除
- Day 5: 基本テストの動作確認

**Week 2: 第2段階**

- Day 1-3: 各テストファイルの修正
- Day 4-5: テスト実行とデバッグ

**Week 3: 第3段階**

- Day 1-3: テスト構造の最適化
- Day 4-5: 最終検証とドキュメント更新

### 成功指標

1. **コード品質**

   - `setup.ts`のサイズ: 1113行 → 200行以下
   - テストの実行成功率: 100%

2. **メンテナンス性**

   - コアライブラリ変更時のテスト修正工数: 50%以上削減
   - テストコードの複雑度低下

3. **統合テストの実現**
   - 実際のsmsshcssコアとの統合テストが実行される
   - プラグインとコアの互換性が保証される

### リスク対策

1. **テスト失敗のリスク**

   - 段階的な変更により影響範囲を限定
   - 各段階での動作確認を徹底

2. **パフォーマンス低下のリスク**

   - 必要最小限のモックを維持
   - テスト実行時間の監視

3. **リグレッションリスク**
   - 既存テストケースの期待値を慎重に更新
   - 変更前後の動作比較を実施

---

## 現状と今後の作業手順

### ✅ 完了済み：全段階の改修完了（2024年12月現在）

#### ✅ 完了済み：第1段階 - モック戦略の見直し

**実施内容:**

- `setup.ts`を1113行から**47行に96%削減**
- `vi.mock('smsshcss', ...)`を全面モックから部分モックに変更
- 重複ロジックを全削除：
  - `generateMockCSS`関数
  - `parseUtilityClasses`、`parseUtilityClass`等のパース関数群
  - `mockExtractCustom...Classes`関数群
  - `mockGenerateApplyClasses`関数

**成果:**

- ✅ `setup.ts`のサイズが96%削減
- ✅ 実際のsmsshcssコアライブラリを使用する体制が構築
- ✅ Reset/Base CSS関連の期待値修正完了（`/* Reset CSS */` → `/* reset.css */`）

#### ✅ 完了済み：第2段階 - テストケースの修正（完全完了）

**実施内容:**

- 全6個のテストファイルの修正完了
- 新規テスト追加：Positioning Classes、Overflow Classes
- smsshcssコアの`generator.ts`に`generateOverflowClasses()`を追加
- Apply機能のプラグインベースアーキテクチャ実装

**最終成果:**

- ✅ **全109個のテストが成功**（100%成功率）
- ✅ `utility-classes.test.ts`: 20/20テスト成功
- ✅ `plugin.test.ts`: 21/21テスト成功
- ✅ `custom-values.test.ts`: 23/23テスト成功
- ✅ `compatibility.test.ts`: 19/19テスト成功
- ✅ `integration.test.ts`: 19/19テスト成功
- ✅ `performance.test.ts`: 7/7テスト成功
- ✅ 実際のsmsshcssコアとの統合テスト実現

#### ✅ 完了済み：第3段階 - テスト構造の最適化

**実施内容:**

- Apply機能のプラグインベースアーキテクチャ実装
- 11個の専門プラグインによる高度なユーティリティクラス処理
- テストヘルパーの整理と最適化
- デバッグ用コードの削除完了

**技術的成果:**

- ✅ プラグインレジストリシステム実装
- ✅ 優先度ベースの処理順序実装
- ✅ 拡張性の高いアーキテクチャ構築

### 🎉 改修完了の総合評価

#### 📊 成功指標の達成状況

1. **コード品質**

   - ✅ `setup.ts`のサイズ: 1113行 → 47行（96%削減）
   - ✅ テストの実行成功率: **100%** (109/109)

2. **メンテナンス性**

   - ✅ コアライブラリ変更時のテスト修正工数: **大幅削減**
   - ✅ テストコードの複雑度: **大幅低下**

3. **統合テストの実現**
   - ✅ 実際のsmsshcssコアとの統合テストが実行される
   - ✅ プラグインとコアの互換性が保証される

#### 🔧 技術的な成果

**Apply機能の高度化:**

```typescript
// 11個のApplyプラグインが自動登録
[Apply] Registered plugins: [
  'spacing',   'size',      'color',     'flexbox',
  'grid',      'display',   'font-size', 'order',
  'z-index',   'positioning', 'overflow'
]
```

**真の統合テスト:**

```typescript
// 実際のCSSGeneratorを使用
const CSSGenerator = (actualSmsshcss as typeof import('smsshcss')).CSSGenerator;
const generator = new CSSGenerator(config);
const css = await generator.generateFullCSS();
```

#### 📈 パフォーマンス

- **テスト実行時間**: 7.54秒（許容範囲内）
- **メモリ効率**: 大幅改善
- **並列処理**: 効率的な同時実行

### 🏆 プロジェクトの成果

この改修により、以下の重要な目標を**完全に達成**しました：

1. **信頼性の向上**: テストがプラグインと実際の `smsshcss` コアとの統合を検証
2. **メンテナンスコストの削減**: `smsshcss` コアの変更がテストコードに与える影響を最小化
3. **テストコードの簡素化**: `setup.ts` が大幅に小さく、理解しやすくなった
4. **拡張性の向上**: プラグインベースアーキテクチャにより新機能の追加が容易

### 📋 今後の保守作業

#### 定期的なメンテナンス

1. **新しいユーティリティクラスの追加**

   - 新しいApplyプラグインの作成
   - 既存プラグインの拡張

2. **パフォーマンス監視**

   - テスト実行時間の監視
   - メモリ使用量の監視

3. **コアライブラリとの同期**
   - smsshcssコアの更新に合わせたテストの調整
   - 新機能のテストケース追加

#### 推奨される開発フロー

```bash
# 新しいユーティリティクラスのテスト追加
cd packages/@smsshcss/vite
yarn test utility-classes.test.ts

# 統合テストの実行
yarn test integration.test.ts

# 全テストの実行
yarn test
```

### 🎯 結論

**Viteプラグインのテストケース改善は完全に成功しました。**

- **96%のコード削減**により、メンテナンスコストが大幅に削減
- **100%のテスト成功率**により、品質が保証
- **プラグインベースアーキテクチャ**により、拡張性が向上
- **真の統合テスト**により、実際の環境での動作が保証

この改修により、Viteプラグインは**産業レベルの品質とメンテナンス性**を備えたテストスイートを持つことになりました。
